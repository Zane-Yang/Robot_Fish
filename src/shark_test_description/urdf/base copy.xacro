<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">
  <!-- Loading some constants -->
  <xacro:include filename="$(find uuv_descriptions)/urdf/common.urdf.xacro"/>
  <!-- Loading file with sensor macros -->
  <xacro:include filename="$(find uuv_sensor_ros_plugins)/urdf/sensor_snippets.xacro"/>
  <!-- Loading the UUV simulator ROS plugin macros -->
  <xacro:include filename="$(find uuv_gazebo_ros_plugins)/urdf/snippets.xacro"/>  
  <!-- Loading vehicle's specific macros -->
  <xacro:include filename="$(find shark_test_description)/urdf/snippets.xacro"/>

  

  <!--
    Vehicle's parameters (remember to enter the model parameters below)
  -->

  

  <xacro:property name="mass" value="3.473"/>
  <!-- Center of gravity -->
  <xacro:property name="cog" value="0.038191 -0.0011682 0.019734"/>
  <!-- Fluid density -->
  <xacro:property name="rho" value="1028"/>

  <!-- 网格文件路径 -->
  <xacro:property name="base_link_mesh" value="package://shark_test_description/meshes/base_link.STL"/>
  
  <xacro:macro name="shark_test_base" params="namespace *gazebo">
    <!-- 1. 基础连杆 base_link（复用原有惯性、可视化、碰撞） -->
    <!-- 在URDF中添加虚拟根连杆 -->
    <link name="dummy_root" />
    <joint name="dummy_joint" type="fixed">
      <parent link="dummy_root" />
      <child link="${namespace}/base_link" />
    </joint>


    <link name="${namespace}/base_link">
      <inertial>
        <mass value="1.753" />
        <origin xyz="0.038191 -0.0011682 0.019734" rpy="0 0 0"/>
        <inertia ixx="0.0011992" ixy="-5.9532E-07" ixz="-4.094E-05"
                 iyy="0.0049871" iyz="-7.025E-07" izz="0.0055025" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="${base_link_mesh}" scale="1 1 1" />
        </geometry>
        <material name="white"><color rgba="1 1 1 1" /></material>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="${base_link_mesh}" scale="1 1 1" />
        </geometry>
      </collision>
    </link>
    

    <!-- Gazebo 自碰撞设置 -->
    <gazebo reference="${namespace}/base_link">
      <selfCollide>false</selfCollide>
    </gazebo>
    

    <!-- 插入流体动力学插件 -->
    <xacro:insert_block name="gazebo"/>

                <!-- 绑定水动力插件到base_link -->
    <gazebo reference="${namespace}/base_link">
        <plugin name="underwater_object_plugin" filename="libuuv_underwater_object_plugin.so">
            <link_name>${namespace}/base_link</link_name>
            <fluid_density>${rho}</fluid_density>
            <use_global_current>true</use_global_current>
            <current_velocity_topic>/hydrodynamics/current_velocity</current_velocity_topic>
            
            <!-- 直接硬编码参数，避免作用域问题 -->
            <volume>0.0017</volume>  <!-- 浮力平衡体积 -->
            <center_of_buoyancy>0.038191 -0.0011682 0.029734</center_of_buoyancy>
            
            <!-- bounding box -->
            <bounding_box>
                <length>0.65</length>
                <width>0.32</width>
                <height>0.25</height>
            </bounding_box>

            <!-- 水动力模型参数 -->
            <hydrodynamic_model>
                <type>fossen</type>
                <added_mass>
                    0.1 0 0 0 0 0
                    0 0.05 0 0 0 0
                    0 0 0.05 0 0 0
                    0 0 0 0.001 0 0
                    0 0 0 0 0.001 0
                    0 0 0 0 0 0.001
                </added_mass>
                <linear_damping>10 6 6 1.0 1.0 1.0</linear_damping>
                <quadratic_damping>200 150 150 50 50 50</quadratic_damping>  <!-- 增大阻尼 -->
            </hydrodynamic_model>
        </plugin>
    </gazebo>



    <!-- 包含执行器（推进器、鳍）和传感器 -->
    <xacro:include filename="$(find shark_test_description)/urdf/actuators.xacro"/>
    <xacro:include filename="$(find shark_test_description)/urdf/sensors.xacro"/>
    </xacro:macro>
</robot>
