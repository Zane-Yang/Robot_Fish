<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">
  <!-- 引入依赖宏文件 -->
  <xacro:include filename="$(find uuv_descriptions)/urdf/common.urdf.xacro"/>
  <xacro:include filename="$(find uuv_sensor_ros_plugins)/urdf/sensor_snippets.xacro"/>
  <xacro:include filename="$(find uuv_gazebo_ros_plugins)/urdf/snippets.xacro"/>
  <xacro:include filename="$(find shark_test_description)/urdf/snippets.xacro"/>
  
  <!-- 机器鱼核心参数（包含水动力参数） -->
  <xacro:property name="mass" value="0.003"/>  <!--1.753-->
  <xacro:property name="cog" value="0.038191 -0.0011682 0.019734"/>
  <xacro:property name="cob" value="0.038191 -0.0011682 0.029734"/>  <!-- 浮心 -->
  <xacro:property name="volume" value="0.004"/>  <!-- 排水体积 -->
  <xacro:property name="rho" value="1028"/>
  <xacro:property name="base_link_mesh" value="package://shark_test_description/meshes/base_link.STL"/>
  
  <!-- 机器鱼基础模型宏 -->
  <xacro:macro name="shark_test_base" params="namespace *gazebo inertial_reference_frame">
    <!-- 核心连杆base_link（整合水动力参数） -->
    <link name="${namespace}/base_link">
      <!-- 惯性参数 -->
      <inertial>
        <mass value="${mass}" />
        <origin xyz="${cog}" rpy="0 0 0"/>
        <inertia ixx="0.0011992" ixy="-5.9532E-07" ixz="-4.094E-05"
                 iyy="0.0049871" iyz="-7.025E-07" izz="0.0055025" />
      </inertial>

      <!-- 可视化模型 -->
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="${base_link_mesh}" scale="1 1 1" />
        </geometry>
        <material name="white"><color rgba="1 1 1 1" /></material>
      </visual>

      <!-- 碰撞体 -->
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="${base_link_mesh}" scale="1 1 1" />
        </geometry>
      </collision>
      <collision>
        <origin xyz="${cog}" rpy="0 0 0"/>
        <geometry>
          <box size="0.65 0.32 0.25"/>
        </geometry>
      </collision>

      <!-- 关键：直接在base_link内添加水动力参数 -->
      <neutrally_buoyant>0</neutrally_buoyant>
      <volume>${volume}</volume>
      <center_of_buoyancy>${cob}</center_of_buoyancy>
      <box>
        <width>0.32</width>
        <length>0.65</length>
        <height>0.25</height>
      </box>
      <hydrodynamic_model>
        <type>fossen</type>
        <added_mass>
          0.1   0      0      0      0      0
          0    0.08    0      0      0      0
          0     0     0.12    0      0      0
          0     0      0     0.01    0      0
          0     0      0      0     0.01    0
          0     0      0      0      0     0.01
        </added_mass>
        <linear_damping>200 150 150 50 50 50</linear_damping>  <!-- 增大20倍 -->
        <quadratic_damping>1000 800 800 300 300 300</quadratic_damping>
      </hydrodynamic_model>
    </link>
    
    <!-- Gazebo自碰撞设置 -->
    <gazebo reference="${namespace}/base_link">
      <selfCollide>false</selfCollide>
      <max_contacts>10</max_contacts>
    </gazebo>
    
    <!-- 插入gazebo插件块 -->
    <xacro:insert_block name="gazebo"/>

    <!-- 包含执行器和传感器 -->
    <xacro:include filename="$(find shark_test_description)/urdf/actuators.xacro"/>
    <xacro:include filename="$(find shark_test_description)/urdf/sensors.xacro"/>
  </xacro:macro>
</robot>